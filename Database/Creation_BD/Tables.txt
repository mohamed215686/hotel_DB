-- ########################################################
-- SCRIPT: TABLES & SEQUENCES ONLY (BASE STRUCTURE)
-- ########################################################

SET SERVEROUTPUT ON;
PROMPT Initialisation de la structure de base...;

-- ========================================================
-- 1. NETTOYAGE (DROP TABLES & SEQUENCES)
-- ========================================================
PROMPT Nettoyage de la base de données...;

BEGIN
    -- Drop tables in dependency order (Child -> Parent)
    EXECUTE IMMEDIATE 'DROP TABLE LIGNE_FACTURE CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE FACTURE CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE ASSOCIE CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE RESERVATION CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE SERVICE CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE CHAMBRE CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE CLIENT CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE SYSTEM_AUDIT CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE UTILISATEUR CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE ROLE CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL; 
END;
/

BEGIN
    -- Drop sequences
    EXECUTE IMMEDIATE 'DROP SEQUENCE ROLE_SEQ';
    EXECUTE IMMEDIATE 'DROP SEQUENCE UTILISATEUR_SEQ';
    EXECUTE IMMEDIATE 'DROP SEQUENCE CLIENT_SEQ';
    EXECUTE IMMEDIATE 'DROP SEQUENCE CHAMBRE_SEQ';
    EXECUTE IMMEDIATE 'DROP SEQUENCE SERVICE_SEQ';
    EXECUTE IMMEDIATE 'DROP SEQUENCE RESERVATION_SEQ';
    EXECUTE IMMEDIATE 'DROP SEQUENCE FACTURE_SEQ';
    EXECUTE IMMEDIATE 'DROP SEQUENCE LIGNE_FACTURE_SEQ';
    EXECUTE IMMEDIATE 'DROP SEQUENCE AUDIT_SEQ';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

-- ========================================================
-- 2. CREATION DES SEQUENCES
-- ========================================================
PROMPT Création des séquences...;

CREATE SEQUENCE ROLE_SEQ START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE UTILISATEUR_SEQ START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE CLIENT_SEQ START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE CHAMBRE_SEQ START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SERVICE_SEQ START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE RESERVATION_SEQ START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE FACTURE_SEQ START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE LIGNE_FACTURE_SEQ START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE AUDIT_SEQ START WITH 1 INCREMENT BY 1;

-- ========================================================
-- 3. CREATION DES TABLES (SCHEMA)
-- ========================================================
PROMPT Création des tables...;

CREATE TABLE ROLE (
    ROLE_ID NUMBER PRIMARY KEY,
    NOMROLE VARCHAR2(20),
    DESCRIPTION VARCHAR2(50)
);

CREATE TABLE UTILISATEUR (
    UTILISATEUR_ID NUMBER PRIMARY KEY,
    ROLE_ID NUMBER NOT NULL,
    LOGIN VARCHAR2(20),
    MOTDEPASSEHASH VARCHAR2(20),
    ACTIF CHAR(1),
    CONSTRAINT FK_USER_ROLE FOREIGN KEY (ROLE_ID) REFERENCES ROLE(ROLE_ID)
);

CREATE TABLE SYSTEM_AUDIT (
    AUDIT_ID NUMBER PRIMARY KEY,
    UTILISATEUR_ID NUMBER,
    TABLENAME VARCHAR2(100),
    ACTION VARCHAR2(50),
    OLDVALUE CLOB,
    NEWVALUE CLOB,
    TIMESTAMP DATE,
    CONSTRAINT FK_AUDIT_USER FOREIGN KEY (UTILISATEUR_ID) REFERENCES UTILISATEUR(UTILISATEUR_ID)
);

CREATE TABLE CLIENT (
    CLIENT_ID NUMBER PRIMARY KEY,
    UTILISATEUR_ID NUMBER, -- Nullable (for walk-ins)
    NOM VARCHAR2(30),
    PRENOM VARCHAR2(30),
    TELEPHONE VARCHAR2(10),
    EMAIL VARCHAR2(100),
    ADRESSE VARCHAR2(100),
    DATE_INSCRIPTION DATE,
    CONSTRAINT FK_CLIENT_USER FOREIGN KEY (UTILISATEUR_ID) REFERENCES UTILISATEUR(UTILISATEUR_ID)
);

CREATE TABLE CHAMBRE (
    CHAMBRE_ID NUMBER PRIMARY KEY,
    NUMERO VARCHAR2(10),
    TYPE VARCHAR2(50),
    PRIX_NUITEE NUMBER CHECK (PRIX_NUITEE >= 0),
    STATUT VARCHAR2(20)
);

CREATE TABLE SERVICE (
    SERVICE_ID NUMBER PRIMARY KEY,
    LIBELLE VARCHAR2(50),
    TARIF_UNITAIRE NUMBER
);

CREATE TABLE RESERVATION (
    RES_ID NUMBER PRIMARY KEY,
    CLIENT_ID NUMBER NOT NULL,
    CHAMBRE_ID NUMBER NOT NULL,
    DATE_DEBUT DATE,
    DATE_FIN DATE,
    STATUT VARCHAR2(20),
    DATE_CREATION DATE,
    CONSTRAINT FK_RES_CLIENT FOREIGN KEY (CLIENT_ID) REFERENCES CLIENT(CLIENT_ID),
    CONSTRAINT FK_RES_CHAMBRE FOREIGN KEY (CHAMBRE_ID) REFERENCES CHAMBRE(CHAMBRE_ID),
    CONSTRAINT CHK_RES_DATES CHECK (DATE_FIN >= DATE_DEBUT)
);

CREATE TABLE ASSOCIE (
    RES_ID NUMBER NOT NULL,
    SERVICE_ID NUMBER NOT NULL,
    CONSTRAINT PK_ASSOCIE PRIMARY KEY (RES_ID, SERVICE_ID),
    CONSTRAINT FK_ASSOC_SERV FOREIGN KEY (SERVICE_ID) REFERENCES SERVICE(SERVICE_ID),
    CONSTRAINT FK_ASSOC_RES FOREIGN KEY (RES_ID) REFERENCES RESERVATION(RES_ID)
);

-- TABLE FACTURE (Updated columns based on your Image)
CREATE TABLE FACTURE (
    FACTURE_ID NUMBER PRIMARY KEY,
    RES_ID NUMBER NOT NULL,       -- Logic: 1 Facture per Reservation
    MONT_TOTAL NUMBER DEFAULT 0 CHECK (MONT_TOTAL >= 0),
    STATUT_PAIEMENT VARCHAR2(20), -- Image: Statut_Paiment
    DATE_PAIEMENT DATE,           -- Image: Date_Paiment
    DATE_EMISSION DATE,           -- Image: DateEmission
    CONSTRAINT FK_FACTURE_RES FOREIGN KEY (RES_ID) REFERENCES RESERVATION(RES_ID)
);

-- TABLE LIGNE_FACTURE (Updated columns based on your Image)
CREATE TABLE LIGNE_FACTURE (
    LIGNE_FACTURE_ID NUMBER PRIMARY KEY, -- Image: Ligne_Facture_ID
    FACTURE_ID NUMBER NOT NULL,          -- Cardinality 1,n link
    LIBELLE_DESCRIPTION VARCHAR2(50),    -- Image: Libelle_description
    PRIX_UNITAIRE NUMBER,                -- Image: PrixUnitaire
    QUANTITE NUMBER,                     -- Image: Quantite
    DATE_CONSOMMATION DATE,              -- Image: DateConsommation
    MONTANT_PARTIEL NUMBER,              -- Image: MontantPartiel
    CONSTRAINT FK_LIGNE_FACT FOREIGN KEY (FACTURE_ID) REFERENCES FACTURE(FACTURE_ID)
);

PROMPT Structure de la base créée avec succès.;