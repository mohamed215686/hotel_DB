CREATE OR REPLACE PROCEDURE PRC_INSCRIPTION_CLIENT (
    p_login IN VARCHAR2,
    p_motdepassehash IN VARCHAR2,
    p_nom IN VARCHAR2,
    p_prenom IN VARCHAR2,
    p_telephone IN VARCHAR2,
    p_email IN VARCHAR2,
    p_adresse IN VARCHAR2,
    p_message OUT VARCHAR2
)
AS
    v_new_user_id NUMBER;
    v_role_client_id CONSTANT NUMBER := 2; -- Assuming Role ID 2 is the 'Client' role
    v_count NUMBER;
BEGIN
    -- 1. Pre-validation: Check if the login or email already exists
    SELECT COUNT(*) INTO v_count FROM UTILISATEUR WHERE LOGIN = p_login;
    IF v_count > 0 THEN
        p_message := 'Erreur: Le nom d''utilisateur existe déjà.';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO v_count FROM CLIENT WHERE EMAIL = p_email;
    IF v_count > 0 THEN
        p_message := 'Erreur: L''adresse e-mail existe déjà.';
        RETURN;
    END IF;

    -- 2. Insert into UTILISATEUR
    INSERT INTO UTILISATEUR (
        UTILISATEUR_ID, ROLE_ID, LOGIN, MOTDEPASSEHASH, ACTIF
    )
    VALUES (
        UTILISATEUR_SEQ.NEXTVAL, v_role_client_id, p_login, p_motdepassehash, 'Y'
    )
    RETURNING UTILISATEUR_ID INTO v_new_user_id;

    -- 3. Insert into CLIENT, linked by the new UTILISATEUR_ID
    INSERT INTO CLIENT (
        CLIENT_ID, UTILISATEUR_ID, NOM, PRENOM, TELEPHONE, EMAIL, ADRESSE, DATE_INSCRIPTION
    )
    VALUES (
        CLIENT_SEQ.NEXTVAL, v_new_user_id, p_nom, p_prenom, p_telephone, p_email, p_adresse, SYSDATE
    );

    COMMIT;
    p_message := 'Succès: Inscription réussie. Utilisateur ID: ' || v_new_user_id;

EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        p_message := 'Erreur inattendue lors de l''inscription: ' || SQLERRM;
        -- Reraising the error or returning the message is up to the application's error handling philosophy
END PRC_INSCRIPTION_CLIENT;
/