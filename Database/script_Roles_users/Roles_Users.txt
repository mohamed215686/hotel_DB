-- ########################################################
-- SECURITE AVANCÉE : VERSION FINALE (CLIENT + STAFF + ADMIN)
-- A exécuter en tant que SYSTEM
-- ########################################################
SET SERVEROUTPUT ON;

-- ⚠️ COMMAND TO ALLOW SIMPLE USER NAMES (Oracle 12c+)
ALTER SESSION SET "_ORACLE_SCRIPT"=true;

-- ========================================================
-- 1. NETTOYAGE (Suppression pour repartir de zéro)
-- ========================================================
BEGIN
    EXECUTE IMMEDIATE 'DROP USER APP_CLIENT CASCADE'; -- Nouveau
EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN
    EXECUTE IMMEDIATE 'DROP USER APP_RECEPTION CASCADE';
EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN
    EXECUTE IMMEDIATE 'DROP USER APP_MANAGER CASCADE';
EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN
    EXECUTE IMMEDIATE 'DROP USER APP_ADMIN CASCADE'; 
EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN
    EXECUTE IMMEDIATE 'DROP ROLE ROLE_CLIENT_DB'; -- Nouveau
EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN
    EXECUTE IMMEDIATE 'DROP ROLE ROLE_RECEPTIONNISTE_DB';
EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN
    EXECUTE IMMEDIATE 'DROP ROLE ROLE_MANAGER_DB';
EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN
    EXECUTE IMMEDIATE 'DROP ROLE ROLE_ADMIN_DB';
EXCEPTION WHEN OTHERS THEN NULL; END;
/

-- ========================================================
-- 2. CREATION DES ROLES MÉTIER
-- ========================================================

-- A. LE RÔLE CLIENT (Niveau 0 - Public/Web)
-- Droits limités : Voir l'offre et réserver pour soi-même
CREATE ROLE ROLE_CLIENT_DB;
GRANT CREATE SESSION TO ROLE_CLIENT_DB;

-- Lecture seule sur le catalogue (Chambres/Services)
GRANT SELECT ON SYSTEM.CHAMBRE TO ROLE_CLIENT_DB;
GRANT SELECT ON SYSTEM.SERVICE TO ROLE_CLIENT_DB;

-- Droit de créer sa propre fiche et sa réservation
GRANT INSERT ON SYSTEM.CLIENT TO ROLE_CLIENT_DB;
GRANT INSERT ON SYSTEM.RESERVATION TO ROLE_CLIENT_DB;
-- Note: Dans un vrai système, on utiliserait une Vue pour qu'il ne voie que SES données.
-- Pour le prototype, on donne SELECT pour qu'il puisse voir sa confirmation.
GRANT SELECT ON SYSTEM.RESERVATION TO ROLE_CLIENT_DB; 

-- Droit d'utiliser les outils de recherche
GRANT EXECUTE ON SYSTEM.F_VERIFIER_DISPONIBILITE TO ROLE_CLIENT_DB;
GRANT EXECUTE ON SYSTEM.F_TROUVER_CHAMBRE_LIBRE TO ROLE_CLIENT_DB;
GRANT EXECUTE ON SYSTEM.P_CREER_RESERVATION TO ROLE_CLIENT_DB; -- Pour réserver
GRANT EXECUTE ON SYSTEM.P_ADD_CLIENT TO ROLE_CLIENT_DB; -- Pour s'inscrire

-- Séquences nécessaires
GRANT SELECT ON SYSTEM.CLIENT_SEQ TO ROLE_CLIENT_DB;
GRANT SELECT ON SYSTEM.RESERVATION_SEQ TO ROLE_CLIENT_DB;
GRANT SELECT ON SYSTEM.UTILISATEUR_SEQ TO ROLE_CLIENT_DB;


-- B. LE RÔLE RÉCEPTIONNISTE (Niveau 1 - Staff)
CREATE ROLE ROLE_RECEPTIONNISTE_DB;
GRANT CREATE SESSION TO ROLE_RECEPTIONNISTE_DB;

-- Le Réceptionniste a besoin de tout ce que fait le client + la gestion
GRANT ROLE_CLIENT_DB TO ROLE_RECEPTIONNISTE_DB;

-- Droits de gestion étendus (Update/Delete si nécessaire)
GRANT SELECT, INSERT, UPDATE ON SYSTEM.CLIENT TO ROLE_RECEPTIONNISTE_DB;
GRANT UPDATE ON SYSTEM.RESERVATION TO ROLE_RECEPTIONNISTE_DB; -- Pour Check-in/out
GRANT SELECT, INSERT ON SYSTEM.ASSOCIE TO ROLE_RECEPTIONNISTE_DB;

-- Procédures exclusives au Staff
GRANT EXECUTE ON SYSTEM.P_CHECK_IN TO ROLE_RECEPTIONNISTE_DB;
GRANT EXECUTE ON SYSTEM.P_CHECK_OUT TO ROLE_RECEPTIONNISTE_DB;
GRANT EXECUTE ON SYSTEM.P_AJOUTER_SERVICE TO ROLE_RECEPTIONNISTE_DB;
GRANT EXECUTE ON SYSTEM.P_GENERATE_FACTURE TO ROLE_RECEPTIONNISTE_DB;
GRANT EXECUTE ON SYSTEM.P_MARK_FACTURE_PAID TO ROLE_RECEPTIONNISTE_DB;

-- Séquences Staff
GRANT SELECT ON SYSTEM.FACTURE_SEQ TO ROLE_RECEPTIONNISTE_DB;
GRANT SELECT ON SYSTEM.LIGNE_FACTURE_SEQ TO ROLE_RECEPTIONNISTE_DB;


-- C. LE RÔLE MANAGER (Niveau 2 - Gestion)
CREATE ROLE ROLE_MANAGER_DB;
GRANT CREATE SESSION TO ROLE_MANAGER_DB;

-- Le Manager hérite du Réceptionniste
GRANT ROLE_RECEPTIONNISTE_DB TO ROLE_MANAGER_DB;

-- Droits Stratégiques (Prix, Audit)
GRANT INSERT, UPDATE, DELETE ON SYSTEM.CHAMBRE TO ROLE_MANAGER_DB; -- Changer les prix
GRANT INSERT, UPDATE, DELETE ON SYSTEM.SERVICE TO ROLE_MANAGER_DB; -- Changer le menu
GRANT SELECT ON SYSTEM.SYSTEM_AUDIT TO ROLE_MANAGER_DB; -- Voir les logs
GRANT SELECT, UPDATE ON SYSTEM.UTILISATEUR TO ROLE_MANAGER_DB; -- Gérer les comptes


-- D. LE RÔLE ADMIN (Niveau 3 - Dieu)
CREATE ROLE ROLE_ADMIN_DB;
GRANT CREATE SESSION TO ROLE_ADMIN_DB;
GRANT ALL PRIVILEGES TO ROLE_ADMIN_DB; 

-- ========================================================
-- 3. CREATION DES UTILISATEURS DE TEST
-- ========================================================

-- 1. Utilisateur Client (Test Web)
CREATE USER APP_CLIENT IDENTIFIED BY "Client123";
GRANT ROLE_CLIENT_DB TO APP_CLIENT;
ALTER USER APP_CLIENT QUOTA UNLIMITED ON USERS;

-- 2. Utilisateur Réception (Sophie)
CREATE USER APP_RECEPTION IDENTIFIED BY "Recep123";
GRANT ROLE_RECEPTIONNISTE_DB TO APP_RECEPTION;
ALTER USER APP_RECEPTION QUOTA UNLIMITED ON USERS;

-- 3. Utilisateur Manager (Marc)
CREATE USER APP_MANAGER IDENTIFIED BY "Manager123";
GRANT ROLE_MANAGER_DB TO APP_MANAGER;
ALTER USER APP_MANAGER QUOTA UNLIMITED ON USERS;

-- 4. Utilisateur Admin (Super-User)
CREATE USER APP_ADMIN IDENTIFIED BY "Admin123";
GRANT ROLE_ADMIN_DB TO APP_ADMIN;
ALTER USER APP_ADMIN QUOTA UNLIMITED ON USERS;

PROMPT Sécurité SGBD (4 Niveaux) installée avec succès !;
PROMPT ---------------------------------------------------;
PROMPT 1. APP_CLIENT    / Client123  (Réservation seule);
PROMPT 2. APP_RECEPTION / Recep123   (Opérations hôtel);
PROMPT 3. APP_MANAGER   / Manager123 (Audit + Prix);
PROMPT 4. APP_ADMIN     / Admin123   (Tout pouvoir);
PROMPT ---------------------------------------------------;